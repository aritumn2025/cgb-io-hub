<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>STG48 Controller</title>
    <style>
      :root {
        color-scheme: dark light;
        font-family: "Segoe UI", "Hiragino Sans", sans-serif;
        background: #101418;
        color: #f2f5f8;
      }

      body {
        margin: 0;
        padding: 0;
        min-height: 100vh;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      main {
        width: min(480px, 90vw);
        display: flex;
        flex-direction: column;
        gap: 24px;
        padding: 32px 24px 120px;
        box-sizing: border-box;
        position: relative;
      }

      .status {
        text-align: center;
        font-size: 1rem;
        opacity: 0.9;
        position: fixed;
        bottom: 32px;
        left: 0;
        width: 100%;
        pointer-events: none;
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 6px;
      }
      .status span {
        pointer-events: auto;
        display: inline-flex;
        align-items: center;
        gap: 6px;
      }
      .status-lamp {
        width: 10px;
        height: 10px;
        border-radius: 50%;
        background: #666;
        display: inline-block;
      }

      .controller {
        display: grid;
        gap: 24px;
        grid-template-columns: repeat(2, 1fr);
        align-items: center;
      }

      .stick-area {
        width: 100%;
        aspect-ratio: 1 / 1;
        border-radius: 16px;
        background: rgba(255, 255, 255, 0.06);
        position: relative;
        touch-action: none;
        border: 1px solid rgba(255, 255, 255, 0.1);
      }

      .stick-thumb {
        position: absolute;
        width: 96px;
        height: 96px;
        max-width: 35%;
        max-height: 35%;
        border-radius: 50%;
        background: rgba(88, 156, 255, 0.85);
        box-shadow: 0 10px 24px rgba(0, 0, 0, 0.35);
        pointer-events: none;
        transform: translate(-50%, -50%);
        left: 50%;
        top: 50%;
        transition: transform 80ms ease-out;
      }

      .buttons {
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        gap: 24px;
        width: 100%;
      }

      button {
        font-size: 1.1rem;
        padding: 14px 0;
        border-radius: 999px;
        border: none;
        background: rgba(255, 255, 255, 0.08);
        color: inherit;
        touch-action: manipulation;
        transition: transform 80ms ease, background 120ms ease;
      }

      button:active,
      button.active {
        transform: scale(0.95);
        background: rgba(255, 255, 255, 0.2);
      }

      .info-menu {
        position: fixed;
        top: 12px;
        right: 12px;
        display: flex;
        flex-direction: column;
        align-items: flex-end;
        gap: 12px;
        pointer-events: none;
        z-index: 10;
      }

      .info-toggle {
        width: 44px;
        height: 44px;
        border-radius: 12px;
        border: none;
        background: rgba(255, 255, 255, 0.12);
        color: inherit;
        display: inline-flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        gap: 6px;
        pointer-events: auto;
        cursor: pointer;
        transition: transform 80ms ease, background 120ms ease;
      }

      .info-toggle span {
        width: 20px;
        height: 2px;
        border-radius: 999px;
        background: currentColor;
        transition: transform 160ms ease, opacity 160ms ease;
      }

      .info-toggle:active {
        transform: scale(0.95);
      }

      .info-menu.open .info-toggle {
        background: rgba(255, 255, 255, 0.2);
      }

      .info-menu.open .info-toggle span:nth-child(1) {
        transform: translateY(8px) rotate(45deg);
      }

      .info-menu.open .info-toggle span:nth-child(2) {
        opacity: 0;
      }

      .info-menu.open .info-toggle span:nth-child(3) {
        transform: translateY(-8px) rotate(-45deg);
      }

      .info-panel {
        min-width: 240px;
        max-width: clamp(240px, 60vw, 320px);
        padding: 18px 20px;
        border-radius: 14px;
        background: rgba(8, 12, 16, 0.92);
        border: 1px solid rgba(255, 255, 255, 0.16);
        box-shadow: 0 18px 36px rgba(0, 0, 0, 0.4);
        font-size: 0.9rem;
        line-height: 1.6;
        color: inherit;
        opacity: 0;
        visibility: hidden;
        pointer-events: none;
        transform: translateY(-8px);
        transition: opacity 160ms ease, transform 160ms ease,
          visibility 160ms ease;
      }

      .info-menu.open .info-panel {
        opacity: 1;
        visibility: visible;
        pointer-events: auto;
        transform: translateY(0);
      }

      .info-panel-title {
        margin: 0 0 8px;
        font-size: 1rem;
        font-weight: 600;
      }

      .info-panel p {
        margin: 0;
      }

      .info-panel p + p {
        margin-top: 10px;
      }

      .info-panel code {
        font-family: inherit;
        font-size: 0.86em;
        background: rgba(255, 255, 255, 0.14);
        padding: 0 6px;
        border-radius: 6px;
      }

      .primary-action {
        width: 100%;
        max-width: 280px;
        aspect-ratio: 1 / 1;
        border-radius: 50%;
        padding: 0;
        font-size: 1.2rem;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .id-emphasis {
        font-weight: 600;
        font-size: 1.1rem;
      }
    </style>
  </head>
  <body>
    <main>
      <div class="info-menu" id="info-menu">
        <button
          type="button"
          class="info-toggle"
          id="info-toggle"
          aria-expanded="false"
          aria-controls="info-panel"
          aria-label="操作説明"
        >
          <span></span>
          <span></span>
          <span></span>
        </button>
        <div
          class="info-panel"
          id="info-panel"
          role="dialog"
          aria-labelledby="info-panel-title"
        >
          <p class="info-panel-title" id="info-panel-title">操作説明</p>
          <p>画面左のスティックはドラッグ、右のボタンはタップで入力</p>
        </div>
      </div>
      <section class="controller">
        <div class="stick-area" id="stick">
          <div class="stick-thumb" id="stick-thumb"></div>
        </div>
        <div class="buttons">
          <button type="button" class="primary-action" data-btn="a">
            攻撃
          </button>
        </div>
      </section>
      <p class="status">
        <span data-id></span>
        ／ <span data-status>未接続</span>
        <span class="status-lamp" data-lamp></span>
      </p>
    </main>
    <script>
      const statusEl = document.querySelector("[data-status]");
      const lampEl = document.querySelector("[data-lamp]");
      const idEl = document.querySelector("[data-id]");
      const infoMenu = document.getElementById("info-menu");
      const infoToggle = document.getElementById("info-toggle");
      const params = new URLSearchParams(location.search);
      const rawId = (params.get("id") || "p1").toLowerCase();

      function toFullWidth(str) {
        return str.replace(/[0-9a-z]/gi, (char) => {
          const code = char.charCodeAt(0);
          if (code >= 0x30 && code <= 0x39) {
            return String.fromCharCode(0xff10 + (code - 0x30));
          }
          if (code >= 0x41 && code <= 0x5a) {
            return String.fromCharCode(0xff21 + (code - 0x41));
          }
          if (code >= 0x61 && code <= 0x7a) {
            return String.fromCharCode(0xff41 + (code - 0x61));
          }
          return char;
        });
      }

      function formatDisplayId(id) {
        if (id.startsWith("p")) {
          const suffix = id.slice(1);
          return suffix ? `プレイヤー${toFullWidth(suffix)}` : "プレイヤー";
        }
        return toFullWidth(id);
      }

      const controllerId = rawId;
      idEl.textContent = formatDisplayId(rawId);

      function closeInfoMenu() {
        if (!infoMenu.classList.contains("open")) {
          return;
        }
        infoMenu.classList.remove("open");
        infoToggle.setAttribute("aria-expanded", "false");
      }

      infoToggle.addEventListener("click", (event) => {
        event.stopPropagation();
        const isOpen = infoMenu.classList.toggle("open");
        infoToggle.setAttribute("aria-expanded", String(isOpen));
      });

      document.addEventListener("click", (event) => {
        if (!infoMenu.contains(event.target)) {
          closeInfoMenu();
        }
      });

      document.addEventListener("keydown", (event) => {
        if (event.key === "Escape") {
          const wasOpen = infoMenu.classList.contains("open");
          closeInfoMenu();
          if (wasOpen) {
            infoToggle.focus();
          }
        }
      });

      let ws = null;
      let backoff = 800;
      let lastSent = "";

      const axes = { x: 0, y: 0 };
      const btn = { a: false };

      function connectionURL() {
        const proto = location.protocol === "https:" ? "wss" : "ws";
        return `${proto}://${location.host}/ws`;
      }

      function updateStatus(text) {
        statusEl.textContent = text;
        const normalized = text.trim();
        let color = "#666";
        if (/接続済み/.test(normalized)) {
          color = "#4caf50";
        } else if (/再試行中/.test(normalized) || /接続中/.test(normalized)) {
          color = "#f1c40f";
        } else if (/未接続/.test(normalized)) {
          color = "#e74c3c";
        }
        lampEl.style.background = color;
      }

      function sendState(force = false) {
        if (!ws || ws.readyState !== WebSocket.OPEN) {
          return;
        }
        const payload = {
          type: "state",
          id: controllerId,
          axes: { ...axes },
          btn: { ...btn },
          t: Date.now(),
        };
        const serialized = JSON.stringify(payload);
        if (!force && serialized === lastSent) {
          return;
        }
        lastSent = serialized;
        ws.send(serialized);
      }

      function scheduleReconnect() {
        const wait = backoff;
        backoff = Math.min(Math.round(backoff * 1.5), 3000);
        setTimeout(connect, wait);
      }

      function connect() {
        if (ws) {
          try {
            ws.close();
          } catch (_) {}
        }
        updateStatus("接続中…");
        ws = new WebSocket(connectionURL());
        ws.onopen = () => {
          backoff = 800;
          updateStatus("接続済み");
          ws.send(JSON.stringify({ role: "controller", id: controllerId }));
          sendState(true);
        };
        ws.onclose = () => {
          updateStatus("未接続（再試行中）");
          scheduleReconnect();
        };
        ws.onerror = () => {
          ws.close();
        };
      }

      connect();
      setInterval(() => sendState(true), 2500);

      const stick = document.getElementById("stick");
      const thumb = document.getElementById("stick-thumb");
      let activePointer = null;

      function clamp(v) {
        return Math.max(-1, Math.min(1, v));
      }

      function updateStick(event) {
        const rect = stick.getBoundingClientRect();
        const relX = (event.clientX - rect.left) / rect.width;
        const relY = (event.clientY - rect.top) / rect.height;
        const x = clamp(relX * 2 - 1);
        const y = clamp(relY * 2 - 1);
        axes.x = parseFloat(x.toFixed(3));
        axes.y = parseFloat((-y).toFixed(3));
        thumb.style.left = `${(x + 1) * 50}%`;
        thumb.style.top = `${(y + 1) * 50}%`;
        sendState();
      }

      function resetStick() {
        activePointer = null;
        axes.x = 0;
        axes.y = 0;
        thumb.style.left = "50%";
        thumb.style.top = "50%";
        sendState();
      }

      stick.addEventListener("pointerdown", (event) => {
        stick.setPointerCapture(event.pointerId);
        activePointer = event.pointerId;
        updateStick(event);
      });

      stick.addEventListener("pointermove", (event) => {
        if (activePointer !== event.pointerId) return;
        updateStick(event);
      });

      const resetEvents = ["pointerup", "pointercancel", "pointerleave"];
      resetEvents.forEach((type) => {
        stick.addEventListener(type, (event) => {
          if (activePointer !== null && activePointer === event.pointerId) {
            if (stick.hasPointerCapture(event.pointerId)) {
              stick.releasePointerCapture(event.pointerId);
            }
            resetStick();
          }
        });
      });

      document.querySelectorAll("[data-btn]").forEach((button) => {
        const key = button.dataset.btn;
        button.addEventListener("pointerdown", (event) => {
          event.preventDefault();
          button.setPointerCapture(event.pointerId);
          btn[key] = true;
          button.classList.add("active");
          sendState();
        });

        const release = (event) => {
          if (button.hasPointerCapture(event.pointerId)) {
            button.releasePointerCapture(event.pointerId);
          }
          if (!btn[key]) return;
          btn[key] = false;
          button.classList.remove("active");
          sendState();
        };

        button.addEventListener("pointerup", release);
        button.addEventListener("pointercancel", release);
        button.addEventListener("pointerleave", release);
      });
    </script>
  </body>
</html>
