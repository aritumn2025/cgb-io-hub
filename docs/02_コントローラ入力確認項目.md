# CGB コントローラ入力テストチェックリスト

## 事前準備

- [ ] Go ハブが起動しており `/ws` への接続が受け付けられる
- [ ] WebUI コントローラを `http://<hub-host>:8765/?id=p1` などで起動済み
  - 例: https://game.rayfiyo.com/?id=p1
- [ ] CLI 検証用に [vi/websocat](https://github.com/vi/websocat) をインストール済み
- [ ] ハブのログ（標準出力）を確認できる状態にある

## 監視セットアップ（Game 役）

- [ ] 別ターミナルで Game 役として websocat を接続し、
      Controller から届くメッセージを監視する
  ```bash
  websocat -vE wss://game.rayfiyo.com/ws
  {"role":"game"}
  ```
- [ ] ハブ側ログに `role=game` で `connected` が出力される
  ```
  {"time":"2025-10-29T07:10:00.123456789+09:00","level":"INFO","msg":"connected","component":"hub","role":"game","id":"","remote_ip":"::1"}
  ```
- 条件: Game 役の登録メッセージ `{"role":"game"}` を送信した直後に出力される
- WebUI コントローラーを操作すると websocat 側でログが流れる（詳細後述）

## スティック入力確認

- [ ] コントローラをタップ・ドラッグしていない状態で `axes.x` / `axes.y`
      が 0 付近の JSON が届く
  ```json
  {
    "type": "state",
    "id": "p1",
    "axes": { "x": 0, "y": 0 },
    "btn": { "a": false },
    "t": 1761688445279
  }
  ```
- 条件: 接続完了後、操作を行っていないときに周期送信されるハートビート／初期状態
- [ ] 左スティックを右上へドラッグすると `axes.x ≈ 1.0` / `axes.y ≈ 1.0`
      （少数第 3 位まで）となる
  ```json
  {
    "axes": { "x": 1, "y": 0.997 },
    "btn": { "a": false }
  }
  ```
- 条件: 右上方向へドラッグしている間に送出される状態更新
- [ ] 左スティックを左下へドラッグすると `axes.x ≈ -1.0` / `axes.y ≈ -1.0` となる
  ```json
  {
    "axes": { "x": -0.998, "y": -1 },
    "btn": { "a": false }
  }
  ```
- 条件: 左下方向へドラッグしている間に送出される状態更新
- [ ] 指を離すと即座にスティックがセンターへ戻り、
      `axes` が再び 0 / 0 に戻ったペイロードが届く
- 条件: pointerup/pointercancel 発生時に送出され、`axes` が 0 / 0 にリセットされる

## ボタン入力確認

- [ ] 攻撃ボタン（画面右側）をタップすると `btn.a` が `true` に変化し、離すと `false` が送信される
  ```json
  {"btn":{"a":true}}
  {"btn":{"a":false}}
  ```
- 条件: `pointerdown` で `true`、`pointerup`/`pointercancel` 等で `false` が送信される
- [ ] ボタンを押しっぱなしにすると `true` のメッセージが維持され、離すと `false` が送信される
- 条件: 押下中に送信されるフレームは `true` を維持し、解放時のフレームで `false` が送信される

## 複合入力確認

- [ ] スティック操作中に攻撃ボタンを押しても、同一メッセージ内で両方の値が更新される
  ```json
  {
    "axes": { "x": 0.523, "y": -0.412 },
    "btn": { "a": true }
  }
  ```
- 条件: スティック移動と攻撃ボタン押下が同じ送信サイクルで発生した際のペイロード例

## ハートビート / 再送確認

- [ ] 入力が静止していても 2 ～ 3 秒に 1 回 `type:"state"` が届き、
      `t` が更新される（ハートビート）
  ```json
  {
    "type": "state",
    "id": "p1",
    "axes": { "x": 0, "y": 0 },
    "btn": { "a": false },
    "t": 1761688447777
  }
  ```
- 条件: 操作がなくてもタイマーにより 2.5 秒周期で送出される
- [ ] 一時的にネットワークを切断・復旧しても WebUI が自動再接続し、
      再び `connected` ログと `state` メッセージが届く
  ```
  {"time":"2025-10-29T07:21:10.456789012+09:00","level":"INFO","msg":"connected","component":"hub","role":"controller","id":"p1","remote_ip":"::1"}
  ```
  - 条件: ハブとの接続が切断されたあと、WebUI の自動再接続が成功したときに出力される

## 終了確認

- [ ] WebUI を閉じる、またはタブをリロードすると、
      ハブ側ログに `role=controller` で `disconnected` が出力される
  ```
  {"time":"2025-10-29T07:25:05.123456789+09:00","level":"INFO","msg":"disconnected","component":"hub","role":"controller","id":"p1","remote_ip":"::1","status":1000,"reason":"normal closure"}
  ```
  - 条件: Controller 側が正常終了またはブラウザを閉じた際に出力される
- [ ] websocat (Game 役) を終了すると、
      ハブ側で `role=game` の `disconnected` ログが記録される
  ```
  {"time":"2025-10-29T07:25:30.987654321+09:00","level":"INFO","msg":"disconnected","component":"hub","role":"game","id":"","remote_ip":"::1","status":1000,"reason":"normal closure"}
  ```
  - 条件: Game 役で接続していた websocat を終了し、WS Close 正常完了時に出力される

## エラーケース確認（任意）

- [ ] Controller 登録時に ID を省略すると `register_missing_id` が WARN 出力され、切断される
  ```bash
  websocat wss://game.rayfiyo.com/ws
  {"role":"controller"}
  ```
  ```
  {"time":"2025-10-29T07:30:12.345678901+09:00","level":"WARN","msg":"register_missing_id","component":"hub","role":"controller","id":"","remote_ip":"::1"}
  ```
  - 条件: `id` フィールドを省いた登録ペイロードを送信した場合に出力される
- [ ] 非許可 ID（日本語など）を送ると `register_invalid_id` が WARN 出力され、Close 1008 が返る
  ```bash
  websocat wss://game.rayfiyo.com/ws
  {"role":"controller","id":"ほげ"}
  ```
  ```
  {"time":"2025-10-29T07:31:00.000000000+09:00","level":"WARN","msg":"register_invalid_id","component":"hub","role":"controller","id":"ほげ","remote_ip":"::1"}
  ```
  - 条件: `^[a-z0-9_-]{1,32}$` に一致しない ID を送信した場合に出力される
- [ ] 登録後に異なる `id` で `state` を送ると `payload_invalid`／`id mismatch` が WARN 出力される
  ```bash
  websocat wss://game.rayfiyo.com/ws
  {"role":"controller","id":"p1"}
  {"type":"state","id":"p2"}
  ```
  ```
  {"time":"2025-10-29T07:32:10.111213141+09:00","level":"WARN","msg":"payload_invalid","component":"hub","role":"controller","id":"p1","remote_ip":"::1","err":"id mismatch"}
  ```
  - 条件: 登録時と異なる `id` を含むメッセージを送信した場合に出力される
- [ ] 空行や壊れた JSON を送ると `register_invalid_json` が WARN 出力される
  ```bash
  websocat wss://game.rayfiyo.com/ws
  {"role":"controller","id":"p1"}
  ```
  ```
  {"time":"2025-10-29T07:33:20.222324252+09:00","level":"WARN","msg":"register_invalid_json","component":"hub","role":"","id":"","remote_ip":"::1","err":"unexpected end of JSON input"}
  ```
  - 条件: JSON 構文エラーを含む登録メッセージを送信した場合に出力される
- [ ] Binary フレームを送ると `register_invalid_type`（登録時）または 1003 Unsupported Data が出力される
  ```bash
  printf '\x01\x02' | websocat -b - wss://game.rayfiyo.com/ws
  ```
  ```
  {"time":"2025-10-29T07:34:30.333435364+09:00","level":"WARN","msg":"register_invalid_type","component":"hub","role":"","id":"","remote_ip":"::1"}
  ```
  - 条件: テキスト以外のフレームで登録を試みた場合に出力され、Close 1003 が返る
- [ ] 接続後 5 秒以内に登録メッセージを送らないと `register_read_failed` が WARN 出力される
  ```
  {"time":"2025-10-29T07:35:40.454647586+09:00","level":"WARN","msg":"register_read_failed","component":"hub","role":"","id":"","remote_ip":"::1","err":"failed to get reader: context deadline exceeded"}
  ```
  - 条件: 接続後に最初のメッセージを送らずに 5 秒経過した場合に出力される
